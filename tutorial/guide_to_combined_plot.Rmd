---
title: "Steps on making combined chip SNP plot"
author: "Thomas Ng"
date: "April 28, 2015"
output: html_document
---

This procedures provides you to instruction on how to generate combined plate's Fluidigm relative intensity plot   
   
##1. Export your chip run as detailed table results (CSV file) under the `export` tab of the Fluidigm SNP's software
   
##2. Preprocess the CSV file to a R-friendly format - outfile name: `combined_plate.CSV`

```{bash}
# change this directory to folder that contains your CSV file
# Be sure that this directory only contains the CSV files that you want to combined
cd /Users/eric.crandall/Desktop/tng/fluidigm/data/raw/recall


echo "plate,ID,Assay,Allele X,Allele Y,Name,Type,Auto,Confidence,Final,Converted,Allele X,Allele Y" > combined_plate.CSV
COUNTER=0
for i in *.csv ; do
COUNTER=$[COUNTER + 1]
perl -e 'chomp;
${file_prefix}=$ARGV[0]; 
open FILE, ${file_prefix}; 
open O, ">".${file_prefix}.".".++$n; 
while(<FILE>){
  if(/^\s*$/) { close O; open O, ">".${file_prefix}.".".++$n; }
  else { print O $_;}
}' $i;
awk 'NR>2' ${i}.3 |perl -p -e 's/\r//g' | awk '{if(NR>1){print '$COUNTER'","$0}}' >> combined_plate.CSV;
done
rm *.csv.*
```

##3. Make the combined plot in R   

Pre-requsite: `ggplot2, plyr, dplyr ` and this [R script](https://github.com/ngthomas/sturgeon_fluidigm/blob/master/src/r/depensity.R) 

```{r, eval=F}
library(ggplot2)
library(plyr)
library(dplyr)

# this should point to the location where you have the R dependency script: depensity.R 
source("/Users/eric.crandall/Desktop/tng/fluidigm/data/temp/depensity.R")

# change to your working directory
setwd("/Users/eric.crandall/Desktop/tng/fluidigm/data/temp")

# read your preprocess csv file
csv.file<-read.csv("combined_plate.csv")

# function makes ggplot pdf file 
# first argument: your csv file; second argument: prefix for your pdf file
# n.groups: # of separated pdf files
MakeIntensityPlot(csv.file, prefix="plate_x_y", n.groups=4)

```

That's it!






## Supporting Script: depensity.R

```{r, eval=FALSE}

MakeIntensityPlot <- function (combined.FILE, prefix="plate_x_y", n.pages = 4, self.exclude=FALSE) {
  
core.data <- ReOrganizeFile_DP(combined.FILE)

core.pdata<-tbl_df(core.data)

repeat.data <- core.pdata %>%
  group_by(assay,name) %>%
  summarise(count = n()) %>%
  filter(count > 1) %>%
  select(assay, name) %>%
  inner_join(core.pdata) 

list.seg<-ddply(repeat.data, .(assay, name), function(x) {
  num.rep <- dim(x)[1]
  all.combn <- combn(1:num.rep, 2)  
  seg.pt <- t(apply(all.combn, 2, function(i) {
    c(x$rel.dye1[i[1]], 
      x$rel.dye2[i[1]],
      x$rel.dye1[i[2]],
      x$rel.dye2[i[2]],
      x$plate[i[1]],
      x$plate[i[2]],
      paste(sort(c(x$plate[i[1]], 
                   x$plate[i[2]])), collapse="_"),
      as.character(x$assay.name[1])
    )}))
  
  colnames(seg.pt)<- c("x.start", "y.start", "x.end", "y.end", "plate.1","plate.2","plate.pair", "assay.name")
  seg.pt
})

if (self.exclude) list.seg <- list.seg %>% filter(as.integer(plate.1)!=as.integer(plate.2))


list.seg$x.start <- as.numeric(as.character(list.seg$x.start))
list.seg$y.start <- as.numeric(as.character(list.seg$y.start))
list.seg$x.end <- as.numeric(as.character(list.seg$x.end))
list.seg$y.end <- as.numeric(as.character(list.seg$y.end))
list.seg$assay.name <- factor(list.seg$assay.name,levels(core.data$assay.name))

n.loci <- length(unique(core.data$assay.name))
for (i in 1:(n.pages)) {
  
  min.intv <- round(n.loci/n.pages)*(i-1)
  max.intv <- min.intv + round(n.loci/n.pages)
  g <- ggplot(data=core.data %>% 
                filter(as.integer(assay.name)>min.intv, as.integer(assay.name) <= max.intv) %>% 
                droplevels(), 
              aes(x=rel.dye1, y=rel.dye2, color=factor(plate))) +
    geom_point(alpha=0.7)
  
  seg.data <- list.seg %>% 
                   filter(as.integer(assay.name)>min.intv, as.integer(assay.name) <= max.intv) %>%
                   droplevels()
  if(nrow(seg.data)>0){
    g<- g + geom_segment(data=seg.data,
                 aes(x=x.start, y=y.start, xend=x.end, yend=y.end, color=plate.pair), linetype=5)
    }
    g<- g+ facet_wrap(~assay.name, ncol = 6 )+
    theme_bw()
  
  ggsave(paste0(prefix,i,".pdf"),g, width = 34, height = 22)
}
}

ReOrganizeFile_DP <- function (test.FILE) {
  test.FILE %>%
    filter(Type=="Unknown") %>% ## remove NTC 
    mutate(
      Name = Name,
      Final = factor(Final, levels=c("No Call","XX","XY", "YY", "Invalid")),
      Assay = factor(Assay, levels = unique(Assay)),
      plate = as.integer(plate),
      assay = as.numeric(Assay),
      name = as.numeric(factor(Name)),
      k = as.numeric(Final) - 1
    ) %>%
    rename(
      rel.dye1 = Allele.X.1,
      rel.dye2 = Allele.Y.1,
      full.name = Name,
      assay.name = Assay,
      plate.name = long_plate_name
    ) %>%
    arrange(assay, name) %>%
    select(plate, assay, name, rel.dye1, rel.dye2, k, full.name, assay.name, plate.name)
}
```

